<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test 403 Fix - Rate Limited Rejoining</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status-box {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
        }
        .status-good { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .status-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .log-area {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }
        .test-button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover { background: #0056b3; }
        .test-button.success { background: #28a745; }
        .test-button.danger { background: #dc3545; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🚫 403 Forbidden Fix Test - Rate Limited Rejoining</h1>
        
        <div class="status-box status-good">
            <strong>✅ FIXES APPLIED:</strong><br>
            • Rate limiting: Prevents rejoining within 2 seconds<br>
            • Group tracking: Prevents rejoining same group<br>
            • Auth fix: Uses isAuthenticated instead of connectAsAuthenticated<br>
        </div>

        <div class="status-box" id="status-display">
            <strong>📊 CURRENT STATUS:</strong><br>
            Socket: <span id="socket-status">Unknown</span><br>
            Auth: <span id="auth-status">Unknown</span><br>
            Group: <span id="group-status">Unknown</span><br>
            403 Count: <span id="forbidden-count">0</span><br>
            Rejoin Count: <span id="rejoin-count">0</span><br>
        </div>

        <div>
            <button class="test-button" onclick="openChat()">💬 Open Chat</button>
            <button class="test-button success" onclick="startMonitoring()">📡 Start Monitoring</button>
            <button class="test-button danger" onclick="clearLogs()">🗑️ Clear Logs</button>
        </div>

        <h3>📋 Event Log</h3>
        <div class="log-area" id="event-log">
            Waiting for events...
        </div>

        <div id="widget-container"></div>
    </div>

    <!-- Load the split widget -->
    <script src="widget-split.js" 
            data-group-name="testgroup6"
            data-api-url="https://pingbash.com"
            data-position="bottom-right"
            data-theme="light"
            data-width="500px"
            data-height="600px"
            data-auto-open="false">
    </script>

    <script>
        let forbiddenCount = 0;
        let rejoinCount = 0;
        let monitoring = false;

        function log(message) {
            const logArea = document.getElementById('event-log');
            const timestamp = new Date().toLocaleTimeString();
            logArea.textContent += `${timestamp}: ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function updateStatus() {
            if (!window.pingbashWidget) return;

            const widget = window.pingbashWidget;
            
            // Socket status
            const socketStatus = widget.socket?.connected ? 'Connected' : 'Disconnected';
            document.getElementById('socket-status').textContent = socketStatus;
            
            // Auth status
            const authStatus = widget.isAuthenticated ? 'Authenticated' : 
                              (widget.anonId ? 'Anonymous' : 'Not Authenticated');
            document.getElementById('auth-status').textContent = authStatus;
            
            // Group status
            const groupStatus = `${widget.groupId || 'None'} (Joined: ${widget.currentJoinedGroupId || 'None'})`;
            document.getElementById('group-status').textContent = groupStatus;
            
            // Update counts
            document.getElementById('forbidden-count').textContent = forbiddenCount;
            document.getElementById('rejoin-count').textContent = rejoinCount;
            
            // Update status box color
            const statusBox = document.getElementById('status-display');
            if (forbiddenCount > 5) {
                statusBox.className = 'status-box status-error';
            } else if (forbiddenCount > 0) {
                statusBox.className = 'status-box status-warning';
            } else {
                statusBox.className = 'status-box status-good';
            }
        }

        function openChat() {
            log('💬 Opening chat widget...');
            const chatButton = document.querySelector('.pingbash-chat-button');
            if (chatButton) {
                chatButton.click();
                log('✅ Chat opened successfully');
                setTimeout(startMonitoring, 1000);
            } else {
                log('❌ Chat button not found');
            }
        }

        function startMonitoring() {
            if (monitoring) {
                log('⏹️ Stopping monitoring');
                monitoring = false;
                return;
            }

            if (!window.pingbashWidget || !window.pingbashWidget.socket) {
                log('❌ Widget or socket not available');
                return;
            }

            monitoring = true;
            log('📡 Starting event monitoring...');

            const widget = window.pingbashWidget;
            const socket = widget.socket;

            // Monitor forbidden events
            const originalForbiddenHandler = socket._callbacks?.$forbidden;
            socket.off('forbidden');
            socket.on('forbidden', (message) => {
                forbiddenCount++;
                log(`🚫 403 FORBIDDEN #${forbiddenCount}: ${message}`);
                updateStatus();
            });

            // Monitor rejoin attempts
            const originalRejoin = widget.rejoinGroupWithCorrectId;
            widget.rejoinGroupWithCorrectId = function() {
                rejoinCount++;
                log(`🔄 REJOIN ATTEMPT #${rejoinCount} for group: ${this.groupId}`);
                updateStatus();
                return originalRejoin.call(this);
            };

            // Monitor connect/disconnect
            socket.on('connect', () => {
                log('🔌 Socket connected');
                updateStatus();
            });

            socket.on('disconnect', (reason) => {
                log(`🔌 Socket disconnected: ${reason}`);
                updateStatus();
            });

            // Monitor group updates
            socket.on('group updated', (data) => {
                log(`📊 Group updated: ${data.name} (ID: ${data.id})`);
                updateStatus();
            });

            // Update status every 2 seconds
            const statusInterval = setInterval(() => {
                if (!monitoring) {
                    clearInterval(statusInterval);
                    return;
                }
                updateStatus();
            }, 2000);

            log('✅ Monitoring started - watching for 403 errors and rejoins');
        }

        function clearLogs() {
            document.getElementById('event-log').textContent = 'Logs cleared...\n';
            forbiddenCount = 0;
            rejoinCount = 0;
            updateStatus();
            log('🗑️ Logs and counters reset');
        }

        // Initial status update
        setTimeout(updateStatus, 1000);
        
        log('🚫 403 Fix Test loaded');
        log('💡 This test monitors for 403 errors and rapid rejoining');
        log('💡 The fixes should prevent infinite loops');
    </script>
</body>
</html> 