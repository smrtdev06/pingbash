<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Configuration Reading</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .test-results {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .pass { color: #28a745; }
        .fail { color: #dc3545; }
        .info { color: #17a2b8; }
        .warning { color: #ffc107; }
        .test-button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button.success {
            background: #28a745;
        }
        .test-button.danger {
            background: #dc3545;
        }
        .json-display {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            white-space: pre;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ”§ Configuration Reading Debug</h1>
        <p>Debugging undefined values in group creation configuration.</p>

        <div class="test-section">
            <h3>ğŸ§ª Configuration Debug Tests</h3>
            <div>
                <button class="test-button" onclick="openChatAndTest()">ğŸ’¬ Open Chat</button>
                <button class="test-button success" onclick="openModalAndDebug()">ğŸ” Open Modal & Debug</button>
                <button class="test-button success" onclick="debugFormElements()">ğŸ“ Debug Form Elements</button>
                <button class="test-button danger" onclick="testConfigReading()">âš™ï¸ Test Config Reading</button>
            </div>
            
            <div class="test-results" id="debug-results">
                Click buttons above to start debugging...
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š Form Elements Analysis</h3>
            <div class="json-display" id="form-analysis">
                Open modal and click "Debug Form Elements" to see analysis...
            </div>
        </div>

        <div class="test-section">
            <h3>âš™ï¸ Configuration Output</h3>
            <div class="json-display" id="config-output">
                Click "Test Config Reading" to see configuration...
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ¯ Widget Integration</h3>
            <div id="widget-container"></div>
        </div>
    </div>

    <!-- Load the split widget -->
    <script src="widget-split.js" 
            data-group-name="memine"
            data-api-url="https://pingbash.com"
            data-position="bottom-right"
            data-theme="light"
            data-width="500px"
            data-height="600px"
            data-auto-open="false">
    </script>

    <script>
        function log(message, target = 'debug-results') {
            const output = document.getElementById(target);
            output.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
        }

        function clearLog(target = 'debug-results') {
            document.getElementById(target).textContent = '';
        }

        function displayJSON(data, target) {
            const output = document.getElementById(target);
            output.textContent = JSON.stringify(data, null, 2);
        }

        function openChatAndTest() {
            log('ğŸ’¬ Opening chat...');
            
            const chatButton = document.querySelector('.pingbash-chat-button');
            if (chatButton) {
                chatButton.click();
                log('âœ… Chat button clicked');
                
                setTimeout(() => {
                    checkWidgetState();
                }, 1000);
            } else {
                log('âŒ Chat button not found - is widget loaded?');
            }
        }

        function checkWidgetState() {
            if (window.pingbashWidget) {
                log(`âœ… Widget authenticated: ${window.pingbashWidget.isAuthenticated}`);
                log(`ğŸ‘¤ User ID: ${window.pingbashWidget.currentUserId}`);
                log(`ğŸŒ API URL: ${window.pingbashWidget.config?.apiUrl}`);
            } else {
                log('âŒ Widget not found');
            }
        }

        function openModalAndDebug() {
            log('ğŸ” Opening group creation modal...');
            
            const logo = document.querySelector('.pingbash-logo');
            if (logo) {
                logo.click();
                log('âœ… Logo clicked');
                
                setTimeout(() => {
                    debugModal();
                }, 1000);
            } else {
                log('âŒ Logo not found - open chat first');
            }
        }

        function debugModal() {
            const bodyModal = document.body.querySelector('.pingbash-group-creation-modal-body');
            if (bodyModal) {
                log('âœ… Body modal found');
                log(`ğŸ“Š Modal class: ${bodyModal.className}`);
                log(`ğŸ“Š Modal display: ${bodyModal.style.display || 'default'}`);
                log(`ğŸ“Š Modal children count: ${bodyModal.children.length}`);
            } else {
                log('âŒ Body modal not found');
            }
        }

        function debugFormElements() {
            log('ğŸ“ Debugging form elements...');
            
            const bodyModal = document.body.querySelector('.pingbash-group-creation-modal-body');
            if (!bodyModal) {
                log('âŒ Body modal not found - open modal first');
                return;
            }

            const elements = [
                { selector: '#group-name-input-body', name: 'Group Name Input' },
                { selector: '#font-size-slider-body', name: 'Font Size Slider' },
                { selector: '#corner-radius-slider-body', name: 'Corner Radius Slider' },
                { selector: '#width-input-body', name: 'Width Input' },
                { selector: '#height-input-body', name: 'Height Input' },
                { selector: 'input[name="size-mode-body"]', name: 'Size Mode Radios' },
                { selector: '#bg-color-body', name: 'Background Color' },
                { selector: '#title-color-body', name: 'Title Color' },
                { selector: '#msg-bg-color-body', name: 'Message Background' },
                { selector: '#msg-text-color-body', name: 'Message Text' },
                { selector: '#input-bg-color-body', name: 'Input Background' },
                { selector: '#show-avatars-body', name: 'Show Avatars' },
                { selector: '#custom-font-size-body', name: 'Custom Font Size' },
                { selector: '#round-corners-body', name: 'Round Corners' },
                { selector: '#show-chat-rules-body', name: 'Show Chat Rules' }
            ];

            const analysis = {
                foundElements: {},
                missingElements: [],
                elementValues: {}
            };

            elements.forEach(element => {
                const el = bodyModal.querySelector(element.selector);
                if (el) {
                    analysis.foundElements[element.name] = {
                        tagName: el.tagName,
                        type: el.type || 'N/A',
                        id: el.id,
                        name: el.name || 'N/A',
                        value: el.value || 'N/A',
                        checked: el.checked || 'N/A'
                    };
                    
                    // Get actual value
                    let actualValue;
                    if (el.type === 'checkbox' || el.type === 'radio') {
                        actualValue = el.checked;
                    } else {
                        actualValue = el.value;
                    }
                    analysis.elementValues[element.name] = actualValue;
                    
                    log(`âœ… ${element.name}: ${actualValue}`);
                } else {
                    analysis.missingElements.push(element.name);
                    log(`âŒ ${element.name}: Missing`);
                }
            });

            // Special check for radio buttons
            const sizeMode = bodyModal.querySelector('input[name="size-mode-body"]:checked');
            if (sizeMode) {
                analysis.elementValues['Selected Size Mode'] = sizeMode.value;
                log(`âœ… Selected Size Mode: ${sizeMode.value}`);
            } else {
                log(`âŒ No size mode selected`);
            }

            displayJSON(analysis, 'form-analysis');
            log(`ğŸ“Š Found ${Object.keys(analysis.foundElements).length} elements`);
            log(`ğŸ“Š Missing ${analysis.missingElements.length} elements`);
        }

        function testConfigReading() {
            log('âš™ï¸ Testing configuration reading...');
            
            if (!window.pingbashWidget) {
                log('âŒ Widget not found');
                return;
            }

            if (typeof window.pingbashWidget.getCurrentConfigFromBodyModal !== 'function') {
                log('âŒ getCurrentConfigFromBodyModal method not found');
                return;
            }

            const bodyModal = document.body.querySelector('.pingbash-group-creation-modal-body');
            if (!bodyModal) {
                log('âŒ Body modal not found - open modal first');
                return;
            }

            try {
                log('ğŸ“¤ Calling getCurrentConfigFromBodyModal...');
                const config = window.pingbashWidget.getCurrentConfigFromBodyModal();
                
                log('âœ… Configuration read successfully');
                
                // Check for undefined values
                const undefinedFields = [];
                Object.keys(config).forEach(key => {
                    if (typeof config[key] === 'object' && config[key] !== null) {
                        // Check nested objects (like colors, settings)
                        Object.keys(config[key]).forEach(nestedKey => {
                            if (config[key][nestedKey] === undefined) {
                                undefinedFields.push(`${key}.${nestedKey}`);
                            }
                        });
                    } else if (config[key] === undefined) {
                        undefinedFields.push(key);
                    }
                });

                if (undefinedFields.length > 0) {
                    log(`âŒ Found undefined fields: ${undefinedFields.join(', ')}`);
                } else {
                    log('âœ… No undefined fields found');
                }

                displayJSON(config, 'config-output');
                
                // Test group data generation
                log('\nğŸ“¤ Testing group data generation...');
                const groupData = {
                    groupName: 'Test Group',
                    createrId: parseInt(window.pingbashWidget.currentUserId || 108),
                    size_mode: config.sizeMode,
                    frame_width: config.width,
                    frame_height: config.height,
                    bg_color: config.colors.background,
                    title_color: config.colors.title,
                    msg_bg_color: config.colors.msgBg,
                    msg_txt_color: config.colors.msgText,
                    reply_msg_color: config.colors.replyText || config.colors.msgText,
                    msg_date_color: config.colors.dateText || config.colors.msgText,
                    input_bg_color: config.colors.inputBg,
                    show_user_img: config.settings.userImages,
                    custom_font_size: config.settings.customFontSize,
                    font_size: config.fontSize,
                    round_corners: config.settings.roundCorners,
                    corner_radius: config.cornerRadius,
                    chat_rules: '',
                    show_chat_rules: config.settings.showChatRules
                };

                // Check for undefined in group data
                const undefinedGroupFields = [];
                Object.keys(groupData).forEach(key => {
                    if (groupData[key] === undefined) {
                        undefinedGroupFields.push(key);
                    }
                });

                if (undefinedGroupFields.length > 0) {
                    log(`âŒ Group data has undefined fields: ${undefinedGroupFields.join(', ')}`);
                } else {
                    log('âœ… Group data has no undefined fields');
                }

                log(`ğŸ“Š Group data preview:`);
                log(`  font_size: ${groupData.font_size} (${typeof groupData.font_size})`);
                log(`  corner_radius: ${groupData.corner_radius} (${typeof groupData.corner_radius})`);
                log(`  size_mode: ${groupData.size_mode} (${typeof groupData.size_mode})`);
                log(`  show_user_img: ${groupData.show_user_img} (${typeof groupData.show_user_img})`);

            } catch (error) {
                log(`âŒ Configuration reading error: ${error.message}`);
                console.error('Configuration error:', error);
            }
        }

        // Initialize
        log('ğŸ”§ Configuration Debug Test loaded');
        log('ğŸ’¡ This will help identify why font_size and corner_radius are undefined');
    </script>
</body>
</html> 