<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Group Creation API</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .test-results {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .pass { color: #28a745; }
        .fail { color: #dc3545; }
        .info { color: #17a2b8; }
        .warning { color: #ffc107; }
        .test-button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button.success {
            background: #28a745;
        }
        .test-button.danger {
            background: #dc3545;
        }
        .json-display {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            white-space: pre;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîß Group Creation API Test</h1>
        <p>Testing and debugging the group creation API call format.</p>

        <div class="test-section">
            <h3>üß™ API Format Tests</h3>
            <div>
                <button class="test-button" onclick="openChatAndTest()">üí¨ Open Chat</button>
                <button class="test-button" onclick="testConfigGeneration()">‚öôÔ∏è Test Config Generation</button>
                <button class="test-button success" onclick="compareWithWVersion()">üîç Compare W Version Format</button>
                <button class="test-button danger" onclick="testActualAPICall()">üöÄ Test API Call</button>
            </div>
            
            <div class="test-results" id="api-test-results">
                Click buttons above to start API format testing...
            </div>
        </div>

        <div class="test-section">
            <h3>üìä W Version vs Widget Comparison</h3>
            <div class="json-display" id="format-comparison">
                Click "Compare W Version Format" to see the comparison...
            </div>
        </div>

        <div class="test-section">
            <h3>üîß Generated Group Data</h3>
            <div class="json-display" id="generated-data">
                Click "Test Config Generation" to see the generated data...
            </div>
        </div>

        <div class="test-section">
            <h3>üì° API Response</h3>
            <div class="json-display" id="api-response">
                Click "Test API Call" to see the response...
            </div>
        </div>

        <div class="test-section">
            <h3>üéØ Widget Integration</h3>
            <div id="widget-container"></div>
        </div>
    </div>

    <!-- Load the split widget -->
    <script src="widget-split.js" 
            data-group-name="memine"
            data-api-url="https://pingbash.com"
            data-position="bottom-right"
            data-theme="light"
            data-width="500px"
            data-height="600px"
            data-auto-open="false">
    </script>

    <script>
        function log(message, target = 'api-test-results') {
            const output = document.getElementById(target);
            output.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
        }

        function clearLog(target = 'api-test-results') {
            document.getElementById(target).textContent = '';
        }

        function displayJSON(data, target) {
            const output = document.getElementById(target);
            output.textContent = JSON.stringify(data, null, 2);
        }

        function openChatAndTest() {
            log('üí¨ Opening chat...');
            
            const chatButton = document.querySelector('.pingbash-chat-button');
            if (chatButton) {
                chatButton.click();
                log('‚úÖ Chat button clicked');
                
                setTimeout(() => {
                    testWidgetState();
                }, 1000);
            } else {
                log('‚ùå Chat button not found - is widget loaded?');
            }
        }

        function testWidgetState() {
            log('üîç Testing widget authentication state...');
            
            if (window.pingbashWidget) {
                log(`‚úÖ Widget found`);
                log(`üîê Authenticated: ${window.pingbashWidget.isAuthenticated}`);
                log(`üé´ Has token: ${!!window.pingbashWidget.authenticatedToken}`);
                log(`üë§ User ID: ${window.pingbashWidget.currentUserId}`);
                log(`üåê API URL: ${window.pingbashWidget.config?.apiUrl}`);
            } else {
                log('‚ùå Widget not found');
            }
        }

        function testConfigGeneration() {
            log('‚öôÔ∏è Testing configuration generation...');
            
            // First open group creation modal
            const logo = document.querySelector('.pingbash-logo');
            if (logo) {
                logo.click();
                log('‚úÖ Logo clicked to open modal');
                
                setTimeout(() => {
                    generateAndDisplayConfig();
                }, 500);
            } else {
                log('‚ùå Logo not found - open chat first');
            }
        }

        function generateAndDisplayConfig() {
            const bodyModal = document.body.querySelector('.pingbash-group-creation-modal-body');
            if (!bodyModal) {
                log('‚ùå Body modal not found');
                return;
            }

            // Fill in some test values
            const groupNameInput = bodyModal.querySelector('#group-name-input-body');
            if (groupNameInput) {
                groupNameInput.value = 'API Test Group';
                log('üìù Set test group name');
            }

            // Test the config generation
            if (window.pingbashWidget && typeof window.pingbashWidget.getCurrentConfigFromBodyModal === 'function') {
                try {
                    const config = window.pingbashWidget.getCurrentConfigFromBodyModal();
                    log('‚úÖ Config generated successfully');
                    
                    // Generate the group data as it would be sent to API
                    const groupData = {
                        groupName: config.groupName,
                        createrId: parseInt(window.pingbashWidget.currentUserId || 108),
                        size_mode: config.sizeMode,
                        frame_width: config.width,
                        frame_height: config.height,
                        bg_color: config.colors.background,
                        title_color: config.colors.title,
                        msg_bg_color: config.colors.msgBg,
                        msg_txt_color: config.colors.msgText,
                        reply_msg_color: config.colors.replyText || config.colors.msgText,
                        msg_date_color: config.colors.dateText || config.colors.msgText,
                        input_bg_color: config.colors.inputBg,
                        show_user_img: config.settings.userImages,
                        custom_font_size: config.settings.customFontSize,
                        font_size: config.settings.fontSize,
                        round_corners: config.settings.roundCorners,
                        corner_radius: config.settings.cornerRadius,
                        chat_rules: '',
                        show_chat_rules: config.settings.showChatRules
                    };

                    displayJSON(groupData, 'generated-data');
                    log('üìä Group data displayed');

                    // Validate data types
                    validateDataTypes(groupData);
                    
                } catch (error) {
                    log(`‚ùå Config generation error: ${error.message}`);
                }
            } else {
                log('‚ùå getCurrentConfigFromBodyModal method not found');
            }
        }

        function validateDataTypes(groupData) {
            log('\nüîç Validating data types...');
            
            const expectedTypes = {
                groupName: 'string',
                createrId: 'number',
                size_mode: 'string',
                frame_width: 'number',
                frame_height: 'number',
                bg_color: 'string',
                title_color: 'string',
                msg_bg_color: 'string',
                msg_txt_color: 'string',
                reply_msg_color: 'string',
                msg_date_color: 'string',
                input_bg_color: 'string',
                show_user_img: 'boolean',
                custom_font_size: 'boolean',
                font_size: 'number',
                round_corners: 'boolean',
                corner_radius: 'number',
                chat_rules: 'string',
                show_chat_rules: 'boolean'
            };

            let allValid = true;
            
            for (const [field, expectedType] of Object.entries(expectedTypes)) {
                const actualType = typeof groupData[field];
                const isValid = actualType === expectedType;
                
                if (!isValid) {
                    log(`‚ùå ${field}: expected ${expectedType}, got ${actualType} (${groupData[field]})`);
                    allValid = false;
                } else {
                    log(`‚úÖ ${field}: ${actualType} (${groupData[field]})`);
                }
            }

            if (allValid) {
                log('\n‚úÖ All data types are correct!');
            } else {
                log('\n‚ùå Some data types are incorrect!');
            }
        }

        function compareWithWVersion() {
            log('üîç Comparing with W version format...');
            
            // W Version format (from the code analysis)
            const wVersionFormat = {
                groupName: "string (newGroupName.trim())",
                createrId: "number (getCurrentUserId())",
                size_mode: "string (groupConfig.sizeMode)", // 'fixed' or 'responsive'
                frame_width: "number (groupConfig.width)",
                frame_height: "number (groupConfig.height)",
                bg_color: "string (groupConfig.colors.background)",
                title_color: "string (groupConfig.colors.title)",
                msg_bg_color: "string (groupConfig.colors.msgBg)",
                msg_txt_color: "string (groupConfig.colors.msgText)",
                reply_msg_color: "string (groupConfig.colors.replyText)",
                msg_date_color: "string (groupConfig.colors.dateText)",
                input_bg_color: "string (groupConfig.colors.inputBg)",
                show_user_img: "boolean (groupConfig.settings.userImages)",
                custom_font_size: "boolean (groupConfig.settings.customFontSize)",
                font_size: "number (groupConfig.settings.fontSize)",
                round_corners: "boolean (groupConfig.settings.roundCorners)",
                corner_radius: "number (groupConfig.settings.cornerRadius)",
                chat_rules: "string (empty '')",
                show_chat_rules: "boolean (groupConfig.settings.showChatRules)"
            };

            // Backend validation (from validations.js)
            const backendValidation = {
                groupName: "Joi.string().required()",
                createrId: "Joi.number().required()",
                size_mode: "Joi.string()",
                frame_width: "Joi.number()",
                frame_height: "Joi.number()",
                bg_color: "Joi.string()",
                title_color: "Joi.string()",
                msg_bg_color: "Joi.string()",
                msg_txt_color: "Joi.string()",
                reply_msg_color: "Joi.string()",
                msg_date_color: "Joi.string()",
                input_bg_color: "Joi.string()",
                show_user_img: "Joi.boolean()",
                custom_font_size: "Joi.boolean()",
                font_size: "Joi.number()",
                round_corners: "Joi.boolean()",
                corner_radius: "Joi.number()",
                chat_rules: "Joi.string().allow('').default('')",
                show_chat_rules: "Joi.boolean().default(false)"
            };

            const comparison = {
                "W Version Format": wVersionFormat,
                "Backend Validation": backendValidation,
                "Key Differences": {
                    "size_mode": "W version uses STRING ('fixed'/'responsive'), NOT number (0/1)",
                    "booleans": "W version uses BOOLEAN (true/false), NOT number (1/0)",
                    "colors": "W version includes reply_msg_color and msg_date_color separately"
                }
            };

            displayJSON(comparison, 'format-comparison');
            log('‚úÖ Format comparison displayed');
        }

        async function testActualAPICall() {
            log('üöÄ Testing actual API call...');
            
            if (!window.pingbashWidget) {
                log('‚ùå Widget not found');
                return;
            }

            if (!window.pingbashWidget.isAuthenticated) {
                log('‚ùå Widget not authenticated - please sign in first');
                return;
            }

            // Generate test data
            const testGroupData = {
                groupName: 'API Test ' + Date.now(),
                createrId: parseInt(window.pingbashWidget.currentUserId),
                size_mode: 'responsive', // STRING not number
                frame_width: 500,
                frame_height: 600,
                bg_color: '#FFFFFF',
                title_color: '#333333',
                msg_bg_color: '#F5F5F5',
                msg_txt_color: '#333333',
                reply_msg_color: '#666666',
                msg_date_color: '#999999',
                input_bg_color: '#FFFFFF',
                show_user_img: true, // BOOLEAN not number
                custom_font_size: false, // BOOLEAN not number
                font_size: 14,
                round_corners: true, // BOOLEAN not number
                corner_radius: 12,
                chat_rules: '',
                show_chat_rules: false // BOOLEAN not number
            };

            log('üì§ Sending API request...');
            log(`üìä Data: ${JSON.stringify(testGroupData, null, 2)}`);

            try {
                const response = await fetch(`${window.pingbashWidget.config.apiUrl}/api/private/add/groups/create`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': window.pingbashWidget.authenticatedToken
                    },
                    body: JSON.stringify(testGroupData)
                });

                log(`üì° Response status: ${response.status} ${response.statusText}`);

                const responseText = await response.text();
                log(`üì° Response text: ${responseText}`);

                let responseData;
                try {
                    responseData = JSON.parse(responseText);
                    log('‚úÖ Response is valid JSON');
                } catch (parseError) {
                    log(`‚ùå Response is not valid JSON: ${parseError.message}`);
                    responseData = { error: 'Invalid JSON response', rawText: responseText };
                }

                displayJSON({
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries()),
                    data: responseData
                }, 'api-response');

                if (response.ok) {
                    log('‚úÖ API call successful!');
                } else {
                    log(`‚ùå API call failed: ${response.status} ${response.statusText}`);
                }

            } catch (error) {
                log(`‚ùå API call error: ${error.message}`);
                displayJSON({
                    error: error.message,
                    stack: error.stack
                }, 'api-response');
            }
        }

        log('üîß Group Creation API Test loaded - ready to debug API calls');
    </script>
</body>
</html> 